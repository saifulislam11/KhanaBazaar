---------------- ALL necessary triggers --------


CREATE OR REPLACE TRIGGER CUSTOMER_PHONE_LIMIT_EXCEEDS
    BEFORE INSERT
    ON CUSTOMER_PHONE
    FOR EACH ROW
DECLARE
    ID           CHAR(10);
    COUNTER      NUMBER;
    LOOP_COUNTER NUMBER;
BEGIN
    --DBMS_OUTPUT.PUT_LINE('HELLO');
    ID := :NEW.CUSTOMER_ID;
    SELECT COUNT(*) INTO COUNTER FROM CUSTOMER_PHONE WHERE CUSTOMER_ID = ID;
    LOOP_COUNTER := 1;
    IF COUNTER >= 2 THEN
        FOR RECORD IN (SELECT * FROM CUSTOMER_PHONE WHERE CUSTOMER_ID = ID )
            LOOP
                --DBMS_OUTPUT.PUT_LINE(RECORD.PHONE_NO);
                IF LOOP_COUNTER <> COUNTER THEN
                    DELETE FROM CUSTOMER_PHONE WHERE CUSTOMER_ID = ID AND PHONE_NO = RECORD.PHONE_NO;
                END IF;
                LOOP_COUNTER := LOOP_COUNTER + 1;

            end loop;
    end if;
END;
/


---------- DELIVERY PICKER --------

CREATE OR REPLACE PROCEDURE ORDER_PICKED(OR_ID IN CHAR, FM_ID IN CHAR) IS
BEGIN

    INSERT INTO DELIVERS(ORDER_ID, FOODMAN_ID) VALUES (OR_ID, FM_ID);

end;
/

CREATE OR REPLACE TRIGGER ORDER_PICKED_TRIGGER
    AFTER INSERT
    ON DELIVERS
    FOR EACH ROW
DECLARE
    OR_ID CHAR(10);
    FM_ID CHAR(10);
BEGIN
    OR_ID := :NEW.ORDER_ID;
    FM_ID := :NEW.FOODMAN_ID;
    UPDATE FOODMAN SET STATUS = 'R' WHERE ID = FM_ID;
    UPDATE "ORDER" SET DELIVERY_TIME = TO_DATE('01-01-1000 00:00:00', 'DD/MM/YYYY HH24:MI:SS') WHERE ID = OR_ID;

end;
/


--------